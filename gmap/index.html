<!DOCTYPE html>
<html>
<head>
  <title>Google Map Route Info with EV Stations</title>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    #controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 5;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 250px;
    }

    #controls input {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    #controls button {
      padding: 10px;
      border: none;
      background-color: #4285F4;
      color: white;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }

    #controls button:hover {
      background-color: #3367D6;
    }

    #info {
      margin-top: 10px;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input id="origin" placeholder="Enter your location" type="text" />
    <input id="destination" placeholder="Enter destination" type="text" />
    <button onclick="calculateRoute()">Get Route</button>
    <div id="info">Distance & Time info will appear here</div>
  </div>
  <div id="map"></div>

  <script>
    let map, directionsService, directionsRenderer, trafficLayer, placesService;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 28.6139, lng: 77.2090 },
        zoom: 13
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false });
      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);

      placesService = new google.maps.places.PlacesService(map);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLoc = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            map.setCenter(userLoc);
            document.getElementById("origin").value = `${userLoc.lat}, ${userLoc.lng}`;
          },
          () => console.log("Geolocation not allowed")
        );
      }
    }

    function calculateRoute() {
      const origin = document.getElementById("origin").value;
      const destination = document.getElementById("destination").value;

      directionsService.route(
        {
          origin: origin,
          destination: destination,
          travelMode: google.maps.TravelMode.DRIVING,
          drivingOptions: {
            departureTime: new Date(),
            trafficModel: 'bestguess'
          }
        },
        (result, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(result);

            const leg = result.routes[0].legs[0];
            const distance = leg.distance.text;
            const duration = leg.duration.text;

            const durationInTraffic = leg.duration_in_traffic
              ? leg.duration_in_traffic.text
              : duration;

            let trafficLevel = "Unknown";
            if (leg.duration_in_traffic) {
              const normalSec = leg.duration.value;
              const trafficSec = leg.duration_in_traffic.value;
              const diffPercent = ((trafficSec - normalSec) / normalSec) * 100;

              if (diffPercent < 20) trafficLevel = "Low";
              else if (diffPercent < 50) trafficLevel = "Medium";
              else trafficLevel = "High";
            }

            document.getElementById("info").innerHTML = `
              <strong>Distance:</strong> ${distance} <br>
              <strong>Estimated Time:</strong> ${duration} <br>
              <strong>Traffic Level:</strong> ${trafficLevel}
            `;

            // Generate TXT file
            const txtContent = `
Origin: ${origin}
Destination: ${destination}
Distance: ${distance}
Estimated Time: ${duration}
Traffic Level: ${trafficLevel}
            `;
            const blob = new Blob([txtContent], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "route_info.txt";
            link.click();

            // Show EV stations on map
            showEVStationsAlongRoute(result.routes[0]);

          } else {
            alert("Error: " + status);
          }
        }
      );
    }

    function showEVStationsAlongRoute(route) {
      const path = route.overview_path;
      const addedStations = new Set();

      for (let i = 0; i < path.length; i += 10) {
        const point = path[i];
        setTimeout(() => {
          const request = {
            location: point,
            radius: 5000,
            keyword: "EV charging station",
            type: "point_of_interest"
          };

          placesService.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              results.forEach((place) => {
                if (!addedStations.has(place.place_id)) {
                  addedStations.add(place.place_id);

                  const marker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    icon: {
                      url: "chargingstat.jpg", // Replace with your image or URL
                      scaledSize: new google.maps.Size(40, 40)
                    },
                    title: place.name
                  });

                  const infowindow = new google.maps.InfoWindow({
                    content: `<strong>${place.name}</strong><br>${place.vicinity || ""}`
                  });

                  marker.addListener("click", () => {
                    infowindow.open(map, marker);
                  });
                }
              });
            } else {
              console.warn("PlacesService failed:", status);
            }
          });
        }, i * 300);
      }
    }
  </script>

  <!-- Replace YOUR_API_KEY_HERE with your real API key -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDM9IOtER3IK3AOQDv0S1OghmgKIJoCsh4&libraries=places&callback=initMap"
    async
    defer
  ></script>
</body>
</html>
