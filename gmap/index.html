<!DOCTYPE html>
<html>
<head>
  <title>EV Route Info </title>
  <style>
    body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; }
    #map { height: 100%; width: 100%; }
    #controls {
      position: absolute; top: 20px; left: 20px; z-index: 5;
      background: rgba(255,255,255,0.95); padding: 15px 20px;
      border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex; flex-direction: column; gap: 10px; min-width: 250px;
    }
    #controls input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    #controls button {
      padding: 10px; border: none; background-color: #4285F4; color: white;
      font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.2s;
    }
    #controls button:hover { background-color: #3367D6; }
    #info { margin-top: 10px; background: #f9f9f9; padding: 10px;
           border-radius: 8px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
           font-size: 14px; color: #333; }
  </style>
</head>
<body>
<div id="controls">
  <input id="origin" placeholder="Enter your location" type="text" />
  <input id="destination" placeholder="Enter destination" type="text" />
  <button onclick="calculateRoute()">Get Route & Send CSV</button>
  <div id="info">Distance & Time info will appear here</div>
</div>
<div id="map"></div>

<script>
let map, directionsService, directionsRenderer, trafficLayer, placesService;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 28.6139, lng: 77.2090 },
    zoom: 13
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false });
  trafficLayer = new google.maps.TrafficLayer();
  trafficLayer.setMap(map);

  placesService = new google.maps.places.PlacesService(map);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const userLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
        map.setCenter(userLoc);
        document.getElementById("origin").value = `${userLoc.lat}, ${userLoc.lng}`;
      },
      () => console.log("Geolocation not allowed")
    );
  }
}

function calculateRoute() {
  const origin = document.getElementById("origin").value;
  const destination = document.getElementById("destination").value;

  directionsService.route({
    origin: origin,
    destination: destination,
    travelMode: google.maps.TravelMode.DRIVING,
    drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' }
  }, (result, status) => {
    if (status === "OK") {
      directionsRenderer.setDirections(result);

      const leg = result.routes[0].legs[0];
      const distance = leg.distance.value / 1000; // km
      const duration = leg.duration.value / 60; // mins
      const trafficSec = leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value;
      const diffPercent = ((trafficSec - leg.duration.value) / leg.duration.value) * 100;

      let trafficLevel = "Unknown";
      if (diffPercent < 20) trafficLevel = "Low";
      else if (diffPercent < 50) trafficLevel = "Medium";
      else trafficLevel = "High";

      document.getElementById("info").innerHTML = `
        <strong>Distance:</strong> ${distance.toFixed(1)} km <br>
        <strong>Estimated Time:</strong> ${Math.round(duration)} mins <br>
        <strong>Traffic Level:</strong> ${trafficLevel}
      `;

      // -------------------------
      // Prepare CSV for model
      // -------------------------
      const csvHeaders = [
        "Speed_kmh","Acceleration_ms2","Battery_State_%","Battery_Voltage_V",
        "Battery_Temperature_C","Driving_Mode","Road_Type","Traffic_Condition",
        "Slope_%","Weather_Condition","Temperature_C","Humidity_%","Wind_Speed_ms",
        "Tire_Pressure_psi","Vehicle_Weight_kg","Distance_Travelled_km"
      ];

      // Mock or predefined data
      const csvData = [
        [
          50,0.5,80,350,30,"Normal","Urban","Moderate",2,"Sunny",32,45,5,32,1500,distance.toFixed(1)
        ]
      ];

      // Convert to CSV string
      const csvContent = [csvHeaders.join(","), ...csvData.map(r => r.join(","))].join("\n");

      // Send CSV to FastAPI
      const formData = new FormData();
      formData.append("file", new Blob([csvContent], { type: "text/csv" }), "lstmdnn.csv");

      fetch("http://localhost:8000/upload-csv/", {
        method: "POST",
        body: formData
      })
      .then(resp => resp.json())
      .then(data => alert("âœ… CSV sent to backend: " + data.saved_path))
      .catch(err => console.error(err));

    } else {
      alert("Error: " + status);
    }
  });
}

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDM9IOtER3IK3AOQDv0S1OghmgKIJoCsh4&libraries=places&callback=initMap" async defer></script>
</body>
</html>
